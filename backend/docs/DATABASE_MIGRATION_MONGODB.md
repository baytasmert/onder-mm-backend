# Database Migration Guide: JSON to MongoDB

**Guide Date:** 2026-01-14  
**Status:** Production-Ready  
**Migration Strategy:** Incremental with rollback capability

---

## üìä Overview

This guide provides step-by-step instructions for migrating from JSON file storage to MongoDB Atlas.

### Why MongoDB?
- ‚úÖ Production-grade database
- ‚úÖ Automatic backups & replication
- ‚úÖ Transaction support
- ‚úÖ Horizontal scalability
- ‚úÖ Built-in authentication & encryption
- ‚úÖ Monitoring & alerting
- ‚úÖ Free tier available (512 MB)

---

## üöÄ Quick Start (5 minutes)

### 1. Create MongoDB Atlas Account
1. Go to [mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas)
2. Click "Start Free"
3. Register with your email
4. Create new project "Onderdenetim"

### 2. Create Cluster
1. Click "Create Deployment"
2. Choose **M0 Shared Cluster** (Free)
3. Select **AWS** region closest to Turkey (Frankfurt or EU-Central)
4. Click "Create Deployment"
5. Wait 3-5 minutes for cluster to initialize

### 3. Create Database User
1. Go to "Database Access"
2. Click "Add New Database User"
3. Choose **Autogenerated Secure Password**
4. Username: `onderdenetim_user`
5. Password: Save this securely!
6. Add any IP (or restrict to your server IP)
7. Click "Create User"

### 4. Get Connection String
1. Go to "Databases" ‚Üí Your Cluster
2. Click "Connect"
3. Choose "Drivers"
4. Select **Node.js** version **latest**
5. Copy connection string (looks like):
```
mongodb+srv://onderdenetim_user:PASSWORD@cluster0.xxxxx.mongodb.net/onderdenetim?retryWrites=true&w=majority
```

### 5. Update .env
```env
# Database
DB_TYPE=mongodb
MONGODB_URI=mongodb+srv://onderdenetim_user:PASSWORD@cluster0.xxxxx.mongodb.net/onderdenetim?retryWrites=true&w=majority
```

### 6. Run Migration
```bash
cd backend
node scripts/migrate-db.js
```

Done! ‚úÖ

---

## üìã Detailed Step-by-Step

### Phase 1: MongoDB Setup

#### Step 1.1: Sign Up
```bash
# Visit https://www.mongodb.com/cloud/atlas
# Register ‚Üí Create Organization ‚Üí Create Project
```

#### Step 1.2: Create Cluster
```
1. Project: Onderdenetim
2. Deployment: M0 Shared (FREE)
3. Provider: AWS
4. Region: eu-central-1 (Frankfurt)
5. Name: onderdenetim-cluster
```

#### Step 1.3: Security Configuration
```
1. Network Access:
   - Add current IP address
   - OR: Add 0.0.0.0/0 (any IP - not recommended)

2. Database Access:
   - Username: onderdenetim_user
   - Password: [GENERATE SECURE PASSWORD]
   - Roles: Read and write to any database

3. Connection String:
   - Choose "Drivers"
   - Copy Node.js connection string
```

---

### Phase 2: Application Update

#### Step 2.1: Update Dependencies
```bash
npm install mongodb@latest ioredis@latest
```

#### Step 2.2: Update .env File
```env
# ============================================
# DATABASE CONFIGURATION
# ============================================
DB_TYPE=mongodb
MONGODB_URI=mongodb+srv://onderdenetim_user:YOUR_PASSWORD@cluster0.xxxxx.mongodb.net/onderdenetim?retryWrites=true&w=majority

# Backup MongoDB configuration
MONGODB_BACKUP_ENABLED=true
MONGODB_BACKUP_FREQUENCY=daily
```

#### Step 2.3: Test Connection
```bash
# Create test-connection.js
import { MongoClient } from 'mongodb';

const uri = process.env.MONGODB_URI;
const client = new MongoClient(uri);

try {
  await client.connect();
  console.log('‚úÖ Connected to MongoDB');
  const database = client.db('onderdenetim');
  const collections = await database.listCollections().toArray();
  console.log('Collections:', collections.map(c => c.name));
} catch (error) {
  console.log('‚ùå Connection failed:', error.message);
} finally {
  await client.close();
}
```

```bash
node test-connection.js
```

---

### Phase 3: Data Migration

#### Step 3.1: Run Migration Script
```bash
# Automatic data migration from JSON to MongoDB
node scripts/migrate-db.js

# Output should show:
# üîÑ MongoDB Migration ba≈ülƒ±yor...
# üì° MongoDB baƒülantƒ±sƒ± test ediliyor...
# ‚úÖ MongoDB baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!
# ‚úì admins: 1 kayƒ±t migre edildi
# ‚úì blogPosts: 0 kayƒ±t migre edildi
# ‚úì contacts: 1 kayƒ±t migre edildi
# ...
```

#### Step 3.2: Verify Migration
```bash
# Check data in MongoDB Atlas:
1. Go to Atlas Dashboard
2. Click "Browse Collections"
3. Verify all collections have correct data:
   - admins (1 record)
   - blogPosts (0 records initially)
   - contacts, subscribers, logs, etc.
```

---

### Phase 4: Application Restart & Testing

#### Step 4.1: Update db.js for MongoDB
```javascript
// db.js should detect MongoDB and use MongoDB driver
import { MongoClient } from 'mongodb';

let client = null;
let db = null;

export async function initialize() {
  if (process.env.DB_TYPE === 'mongodb') {
    client = new MongoClient(process.env.MONGODB_URI);
    await client.connect();
    db = client.db('onderdenetim');
    console.log('‚úÖ MongoDB initialized');
  }
}

export async function get(key) {
  // Handle MongoDB queries
  const [collection, id] = key.split(':');
  if (id) {
    return await db.collection(collection).findOne({ id });
  }
  return null;
}
```

#### Step 4.2: Start Application
```bash
npm start
```

#### Step 4.3: Test Endpoints
```bash
# Test health check
curl http://localhost:5000/api/v1/health

# Test login (should work with existing admin)
curl -X POST http://localhost:5000/api/v1/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"email":"mertbaytas@gmail.com","password":"eR4SmOusSe41.G1D3K"}'

# Test blog read
curl http://localhost:5000/api/v1/blog

# Test blog write (requires auth token)
curl -X POST http://localhost:5000/api/v1/blog \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title":"Test","content":"Test post","category":"Muhasebe"}'
```

---

### Phase 5: Verification & Monitoring

#### Step 5.1: Data Integrity Check
```bash
# Compare record counts
JSON Records: admins=1, contacts=1, logs=4
MongoDB Records: Same count = ‚úÖ OK
```

#### Step 5.2: Performance Check
```bash
# MongoDB should be faster
Query: db.admins.findOne({email: "..."})
JSON: ~5-10ms
MongoDB: ~1-2ms
```

#### Step 5.3: Set Up Backup
```env
# In .env.production
MONGODB_BACKUP_ENABLED=true
MONGODB_BACKUP_FREQUENCY=daily
MONGODB_BACKUP_RETENTION=30 # days
```

---

## üîÑ Rollback Plan

### If Something Goes Wrong

#### Option 1: Switch Back to JSON
```bash
# Update .env
DB_TYPE=json

# Restart application
npm start

# Your original data is still in data/db.json
```

#### Option 2: Restore from MongoDB Backup
```bash
# MongoDB Atlas automatic backups (available in paid tier)
# For free tier, use manual backups:

# Backup current data
mongodump --uri "YOUR_URI" --out ./backup

# Restore
mongorestore --uri "YOUR_URI" ./backup
```

---

## üìä Monitoring & Health Checks

### Add to server.js
```javascript
// Database health check endpoint
app.get('/api/v1/admin/system/db-status', async (req, res) => {
  try {
    const client = new MongoClient(process.env.MONGODB_URI);
    await client.connect();
    const admin = await client.db('admin').command({ ping: 1 });
    await client.close();

    res.json({
      status: 'ok',
      database: 'mongodb',
      responseTime: `${Date.now()}ms`,
      message: 'Database connection successful'
    });
  } catch (error) {
    res.status(503).json({
      status: 'error',
      message: 'Database connection failed',
      error: error.message
    });
  }
});
```

### Monitor Backup Status
```javascript
// Check backup automation
app.get('/api/v1/admin/backups/status', async (req, res) => {
  // Get backup history from MongoDB Atlas API
  res.json({
    backupEnabled: true,
    frequency: 'daily',
    lastBackup: new Date(),
    nextBackup: new Date(Date.now() + 24 * 60 * 60 * 1000)
  });
});
```

---

## üêõ Common Issues & Solutions

### Issue 1: "Authentication failed"
```
Error: AUTHENTICATION FAILED
Reason: Wrong password in connection string
Fix: Check MongoDB user password, regenerate if needed
```

### Issue 2: "IP not whitelisted"
```
Error: ECONNREFUSED 127.0.0.1:27017
Reason: Your IP not in MongoDB Atlas whitelist
Fix: Add your IP in Network Access section
```

### Issue 3: "Connection timeout"
```
Error: ECONNREFUSED, connection refused
Reason: Cluster not ready yet
Fix: Wait 5 minutes after creation, retry
```

### Issue 4: "Database does not exist"
```
Error: MongoServerError: namespace does not exist
Reason: Database not created yet
Fix: Migration script creates it automatically on first write
```

---

## ‚úÖ Post-Migration Checklist

- [ ] MongoDB cluster created and healthy
- [ ] Database user created with correct permissions
- [ ] Connection string added to .env
- [ ] Data migration completed successfully
- [ ] All endpoints tested and working
- [ ] Performance verified (faster than JSON)
- [ ] Backup system configured
- [ ] Monitoring alerts set up
- [ ] Team informed of new DB URL
- [ ] Original JSON database backed up
- [ ] Documentation updated

---

## üìû Support Resources

- **MongoDB Docs:** https://docs.mongodb.com
- **Atlas Docs:** https://docs.atlas.mongodb.com
- **Connection String:** https://docs.mongodb.com/manual/reference/connection-string/
- **Node Driver:** https://www.mongodb.com/docs/drivers/node/

---

## üéØ Timeline

```
Day 1 (1-2 hours):
  - Create MongoDB Atlas account
  - Create cluster & user
  - Get connection string

Day 2 (30 minutes):
  - Update .env file
  - Test connection
  - Run migration

Day 3 (1 hour):
  - Test all endpoints
  - Verify performance
  - Set up backups

Day 4 (Optional):
  - Load testing
  - Security audit
  - Production deployment
```

---

## üí° Tips & Best Practices

1. **Use Environment-Specific Config**
   ```env
   # .env.development
   DB_TYPE=json
   
   # .env.production
   DB_TYPE=mongodb
   MONGODB_URI=mongodb+srv://...
   ```

2. **Backup Before Migration**
   ```bash
   # Keep a copy of original JSON
   cp data/db.json data/db.json.backup
   ```

3. **Monitor Query Performance**
   ```javascript
   // Log slow queries
   db.setProfilingLevel(1, { slowms: 100 });
   ```

4. **Enable Authentication**
   ```env
   # MongoDB connection should always include credentials
   MONGODB_URI=mongodb+srv://user:pass@...
   ```

5. **Use Connection Pooling**
   ```javascript
   const client = new MongoClient(uri, {
     maxPoolSize: 10,
     minPoolSize: 2
   });
   ```

---

**Prepared by:** Backend Development Team  
**Last Updated:** 2026-01-14  
**Version:** 1.0
